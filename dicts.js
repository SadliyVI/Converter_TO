// dicts.js
// Справочники сокращений/наименований + канонизация.
// Можно дополнять без изменения логики парсинга.

const normKey = (s) =>
    (s ?? "")
        .toString()
        .toUpperCase()
        .replace(/Ё/g, "Е")
        .replace(/\s+/g, " ")
        .trim()
        // выкидываем всё кроме букв/цифр, чтобы пережить разрывы, точки, дефисы
        .replace(/[^0-9A-ZА-Я]/g, "");

function buildDict(spec) {
    // spec: { CANON: [alias1, alias2, ...] }
    const map = new Map();
    for (const [canon, aliases] of Object.entries(spec)) {
        map.set(normKey(canon), canon);
        for (const a of (aliases || [])) map.set(normKey(a), canon);
    }
    return map;
}

function buildDictFromPairs(pairs) {
    const m = new Map();
    for (const [canonVal, variants] of pairs) {
        m.set(normKey(canonVal), canonVal);
        for (const v of variants || []) {
            const k = normKey(v);
            if (k) m.set(k, canonVal);
        }
    }
    return m;
}
function canonize(map, value) {
    if (value == null) return null;
    const v = value.toString().trim();
    if (!v) return null;
    return map.get(normKey(v)) ?? v.replace(/\s+/g, " ").trim();
}

/** ===================== Справочники из "Сокращения.pdf" ===================== */

// Категории защитности (как в документе)
const CATEGORY = buildDict({
    "Леса, расположенные на ООПТ": [
        "Леса, расположенные на особо охраняемых природных территориях",
        "Леса расположенные на ООПТ",
        "Леса расположенные на особо охраняемых природных территориях",
    ],
    "Леса, расположенные в водоохранных зонах": [
        "Леса расположенные в водоохранных зонах",
        "Леса расположенн ые в водоохранных зонах",
        "Леса расположенные в водоохранн ых зонах",
    ],
    "Леса, расположенные в защитных полосах лесов": [
        "Леса, расположенные в защитных полосах лесов",
        "Леса расположенные в защитных полосах лесов",
    ],
    "Леса, расположенные в зеленых зонах": ["Леса расположенные в зеленых зонах"],
    "Запретные полосы лесов": [
        "Запретные полосы лесов, расположенные вдоль водных объектов",
        "Запретные полосы л есов",
    ],
    "Нерестоохранные полосы лесов": ["Нерестоохранные полосы лесов"],
    "Эксплуатационные леса": [
        "Эксплуатацион ные леса",
        "Эксп луатационные леса",
        "Эксплуатационные  леса",
    ],
});

// ОЗУ (наименования особозащитных участков)
const OZU = buildDict({
    "Берегозащитные участки лесов": ["Берегозащитные, повозащитные участки лесов"],
    "ПЛСУ": [
        "Лесосеменные плантации, постоянные лесосеменные участки и другие объекты лесного семеноводства",
        "ПЛСУ",
    ],
    "Участки лесов вокруг ПГТ, сель. нас. пунктов": [
        "Участки лесов вокруг поселков городского типа, сельских населенных пунктов",
    ],
});

// Породы (элемент)
const SPECIES = buildDict({
    "Л": ["Лиственница"],
    "С": ["Сосна"],
    "П": ["Пихта"],
    "Е": ["Ель"],
    "Б": ["Береза", "Берёза"],
    "ОС": ["Осина"],
    "Р": ["Рябина"],
    "ОЛСА": ["Ольха серая"],
    "ОЛЧ": ["Ольха черная", "Ольха чёрная"],
    "МЖ": ["Можжевельник"],
    "ШП": ["Шиповник"],
    "СМ": ["Смородина"],
    "ИВК": ["Ива кустарниковая"],
    "ИВ": ["Ива"],
    "БК": ["Береза карликовая", "Берёза карликовая"],
    "ЧР": ["Черемуха", "Черёмуха"],
});

// Группы типов леса (col13: "Е ДМ", "С ЧЕР"...)
const FOREST_GROUP = buildDict({
    "С ЛИШ": ["Сосняки лишайниковые"],
    "С БР": ["Сосняки брусничные"],
    "С КИС": ["Сосняки кисличные"],
    "С ЧЕР": ["Сосняки черничные"],
    "С ДМ": ["Сосняки долгомошные"],
    "С ДМО": ["Сосняки долгомошные осушенные"],
    "С СФ": ["Сосняки сфагновые"],
    "С СФО": ["Сосняки сфагновые осушенные"],
    "С ТБ": ["Сосняки травяно-болотные"],
    "С ТБО": ["Сосняки травяно-болотные осушенные"],

    "Е КИС": ["Ельники кисличные"],
    "Е ЧЕР": ["Ельники черничные"],
    "Е ПКТ": ["Ельники приручейно-крупнотравные"],
    "Е ДМ": ["Ельники долгомошные"],
    "Е ДМО": ["Ельники долгомошные осушенные"],
    "Е СФ": ["Ельники сфагновые"],
    "Е СФО": ["Ельники сфагновые осушенные"],
    "Е ТБ": ["Ельники травяно-болотные"],
});

// Типы лесорастительных условий (TLU)
const TLU = buildDict({
    "ТР": ["травяный"],
    "ЛШ": ["лишайниковый"],
    "МЛ": ["мохово-лишайниковый"],
    "ВР": ["вересковый"],
    "БР": ["брусничный"],
    "КС": ["кисличный"],
    "ЧС": ["черничный свежий"],
    "ЧВ": ["черничный влажный"],
    "КЛ": ["кустарничково-лишайниковый"],
    "ДМ": ["долгомошный"],
    "СК": ["кустарничково-сфагновый"],
    "СФ": ["сфагновый"],
    "ПС": ["пушицево-сфагновый"],
    "БГ": ["багульниковый"],
    "ЛГ": ["логовой"],
    "ОС": ["осоково-сфагновый"],
    "ВС": ["вахто-сфагновый"],
    "ПК": ["приручейно-крупнотравный"],
    "ТВ": ["таволговый"],
    "ТС": ["травяно-сфагновый"],
});

// Типы вырубок
const CUT_TYPE = buildDict({
    "ЛШ": ["лишайниковая"],
    "ВР": ["вересковая"],
    "В": ["вейниковая"],
    "Л": ["луговиковая"],
    "К": ["кипрейная"],
    "КП": ["кипрейно-паловая"],
    "Т": ["таволговая"],
    "Д": ["долгомошная"],
    "С": ["сфагновая"],
    "КТ": ["крупнотравная"],
    "ОС": ["осоко-сфагновая"],
    "ТБ": ["травяно-болотная"],
});

/** ===================== ваши справочники "kind=OBJECT / kind=VYDEL_HEADER" ===================== */

const OBJECT_KIND = buildDict({
    "Болота": ["Болота", "Болота:", "Бо лота", "Боло та"],
    "Вырубки": ["Вырубки", "Вырубки:"],
    "Дороги грунтовые": ["Дороги грунтовые", "Дороги грунт."],
    "Дороги с иск.покр.": ["Дороги с иск.покр.", "Дороги иск.покр.", "Дороги с иск.покр", "Дор оги с иск.покр."],
    "Культуры": ["Культуры", "Культуры:"],
    "Культуры несомкнувшиеся": ["Культуры несомкнувшиеся", "Культуры несомкнувшиеся:"],
    "Лесосеки года л/у": ["Лесосеки года л/у", "Лесосеки года л/у:"],
    "Насажд.из подроста": ["Насажд.из подроста", "Насажд из подроста", "Насажд.и з подроста"],
    "Насажд.с пор.иск.происх.": ["Насажд.с пор.иск.происх.", "Насажд с пор иск происх"],
    "Насажд.с культ.под полог.": ["Насажд.с культ.под полог.", "Насажд с культ под полог", "Нас ажд.с культ.под полог.", "Насажд.с культ.под поло г."],
    "Просеки кварт.": ["Просеки кварт.", "Просеки кварт", "Просеки"],
    "Реки": ["Реки", "Реки:"],
    "Ручьи": ["Ручьи", "Ручьи:"],
});

const VYDEL_HEADER_KIND = buildDict({
    "Болота": ["Болота", "Болота:", "Бо лота", "Боло та"],
    "Дороги с иск.покр.": ["Дороги с иск.покр.", "Дороги иск.покр.", "Дороги с иск.покр", "Дор оги с иск.покр."],
    "Дороги грунтовые": ["Дороги грунтовые", "Дороги грунт.", "Доро ги грунтовые", "Дорог и грунтовые"],
    "Карьеры действ.": ["Карьеры действ.", "Карьеры действ", "Карьеры"],
    "Культуры лесные": ["Культуры лесные", "Культуры", "Культуры лесн.", "Культур ы лесные", "Культуры ле сные", "Культуры лес ные"],
    "Лэп": ["Лэп", "ЛЭП"],
    "Насажд.с культ.под полог.": ["Насажд.с культ.под полог.", "Насажд с культ под полог", "Нас ажд.с культ.под полог.", "Насажд.с культ.под поло г."],
    "Насажд.из подроста": ["Насажд.из подроста", "Насажд из подроста", "Насажд.и з подроста"],
    "Озера": ["Озера", "Озёра"],
    "Просеки кварт.": ["Просеки кварт.", "Просеки"],
    "Прочие земли": ["Прочие земли", "Земли линейного протяжения", "Земли линейного протяжения:"],
    "Реки": ["Реки", "Реки:"],
    "Ручьи": ["Ручьи", "Ручьи:"],
});

// Хозяйственные мероприятия (колонка 24)
const HOZ_MEROP_RAW = [
    ["Дополнение л/к", [
        "Дополнение л/к",
        "Дополнение л/к:",
        "Дополн ение л/к",
    ]],

    ["Культуры лесные", [
        "Культуры лесные",
        "Лесные культуры",
        "Культуры лесные:",
        "Культу ры лесные",
        "Культуры лесн.",
        "Культур ы лесные",
        "Культуры ле сные",
        "Культуры лес ные",
    ]],

    ["Осветление", [
        "Осветление",
        "Осветление:",
        "Осветл ение",
    ]],

    ["Прореживание", [
        "Прореживание",
        "Прореживание:",
        "Прореж и вание",
        "Прореж ивание",
    ]],

    ["Проходные рубки", [
        "Проходные рубки",
        "Проходные рубки:",
        "Проход н ые рубки",
        "Проход ные руб ки",
        "Проход ные рубки",
    ]],

    ["Прочистки", [
        "Прочистки",
        "Прочистки:",
        "Прочис тки",
    ]],

    ["Разрубка просек", [
        "Разрубка просек",
        "Разрубка просек:",
        "Разруб ка про сек",
    ]],

    ["Расчистка просек", [
        "Расчистка просек",
        "Расчистка просек:",
        "Расчис тк а просек",
        "Расчис тка просе к",
        "Расчис тка просек",
    ]],

    ["С.е.в. минерализ.", [
        "С.е.в. минерализ.",
        "С.е.в. минерализ.:",
    ]],

    ["Уход за сохр.под", [
        "Уход за сохр.под",
        "Уход за сохр.под:",
        "Уход з а сохр.под",
    ]],
];

export const DICTS = {
    CATEGORY,
    OZU,
    SPECIES,
    FOREST_GROUP,
    TLU,
    CUT_TYPE,
    OBJECT_KIND,
    VYDEL_HEADER_KIND,
    HOZ_MEROP: buildDictFromPairs(HOZ_MEROP_RAW),
};

export const canon = {
    category: (s) => canonize(CATEGORY, s),
    ozu: (s) => canonize(OZU, s),
    species: (s) => canonize(SPECIES, s),
    forestGroup: (s) => canonize(FOREST_GROUP, s),
    tlu: (s) => canonize(TLU, s),
    cutType: (s) => canonize(CUT_TYPE, s),

    // “мягкая” канонизация (если не нашли — вернёт исходное)
    objectKind: (s) => canonize(OBJECT_KIND, s),
    vydelHeaderKind: (s) => canonize(VYDEL_HEADER_KIND, s),

    hozMerop(v) {
        if (!v) return null;
        const s = String(v).trim();
        if (!s) return null;
        return DICTS.HOZ_MEROP.get(normKey(s)) ?? s.replace(/\s+/g, " ").trim();
    },
};

export const _internal = { normKey, buildDict, buildDictFromPairs, canonize };